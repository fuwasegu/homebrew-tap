name: Update AirLingua Cask

on:
  repository_dispatch:
    types: [update-airlingua]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Cask
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          SHA256="${{ github.event.client_payload.sha256 }}"

          cat > Casks/airlingua.rb << EOF
          cask "airlingua" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/fuwasegu/AirLingua/releases/download/v#{version}/AirLingua-#{version}.zip"
            name "AirLingua"
            desc "Local LLM translation app for macOS"
            homepage "https://github.com/fuwasegu/AirLingua"

            depends_on macos: ">= :sonoma"

            app "AirLingua.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/AirLingua.app"],
                             sudo: false
              system_command "/usr/bin/SetFile",
                             args: ["-a", "E", "#{appdir}/AirLingua.app"],
                             sudo: false
            end

            zap trash: [
              "~/Library/Application Support/AirLingua",
              "~/Library/Preferences/com.personal.LocalTranslate.plist",
            ]
          end
          EOF

      - name: Commit and Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/airlingua.rb
          git commit -m "Bump airlingua to v${{ github.event.client_payload.version }}"
          git push
